<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RelayBoy Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
/* Global */
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
body { background: #1a1a2e; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; }

/* Header */
h1 { margin-bottom: 20px; }

/* Layout */
.container { display: flex; width: 100%; max-width: 1000px; height: 500px; border-radius: 10px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

/* Sidebar - Online Users */
.users-box { width: 200px; background: #162447; padding: 15px; display: flex; flex-direction: column; }
.users-box h3 { margin-bottom: 10px; }
.online-users { list-style: none; flex: 1; overflow-y: auto; }
.online-users li { padding: 10px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; }
.online-users li:hover { background: #1f4068; }
.avatar { width: 30px; height: 30px; border-radius: 50%; background: #e94560; display: inline-block; margin-right: 10px; text-align: center; line-height: 30px; font-weight: bold; color: #fff; }

/* Chat Box */
.chat-box { flex: 1; background: #1f2861; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
.message { margin-bottom: 10px; padding: 10px 15px; border-radius: 20px; max-width: 70%; word-wrap: break-word; display: inline-block; }
.message.right { background: #e94560; color: #fff; align-self: flex-end; border-bottom-right-radius: 5px; }
.message.left { background: #162447; color: #fff; align-self: flex-start; border-bottom-left-radius: 5px; }
.timestamp { font-size: 0.7em; color: #ccc; margin-left: 5px; }

/* Input Group */
.input-group { display: flex; gap: 10px; margin-top: 10px; width: 100%; max-width: 1000px; }
input, button { padding: 10px; border-radius: 5px; border: none; outline: none; }
input { flex: 1; }
button { background: #e94560; color: #fff; cursor: pointer; transition: 0.2s; }
button:hover { background: #d1344a; }
#error { color: #ff5c5c; margin-top: 10px; text-align: center; }
</style>
</head>
<body>

<h1>RelayBoy Chat</h1>

<div class="input-group">
  <div style="flex:1; color:#ccc; padding:10px;">Open this page after you log in. <a href="/login" style="color:#fff; text-decoration:underline;">Login / Register</a></div>
  <div id="status" style="padding:10px; color:#fff;">Connecting...</div>
</div>
<div id="error"></div>

<div class="container">
  <div class="users-box">
    <h3>Online Users</h3>
    <ul id="users" class="online-users"></ul>
  </div>
  <div class="chat-box" id="chat"></div>
</div>

<div class="input-group" style="margin-top:10px;">
  <input id="msg" placeholder="Type your message" />
  <button onclick="send()">Send</button>
</div>

</script>
<script>
let socket;
let username;
let currentChat = null;
let chatHistory = {};

function connectWS() {
  const protocol = window.location.hostname === "localhost" ? "ws" : "wss";
  socket = new WebSocket(`${protocol}://${window.location.host}`);

  socket.onopen = () => {
    document.getElementById('status').textContent = 'Connected, waiting for server...';
  };

  socket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    const errorDiv = document.getElementById('error');
    if (data.type === 'error') {
      errorDiv.textContent = data.message;
      socket.close();
    }
    if (data.type === 'connected') {
      username = data.username;
      document.getElementById('status').textContent = 'Connected as ' + username;
    }
    if (data.type === 'users') {
      const usersDiv = document.getElementById('users');
      usersDiv.innerHTML = '';
      data.users.filter(u => u !== username).forEach(u => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="avatar">${u.charAt(0).toUpperCase()}</span>${u}`;
        li.onclick = () => openChat(u);
        usersDiv.appendChild(li);
      });
    }
    if (data.type === 'message') {
      if (!chatHistory[data.from]) chatHistory[data.from] = [];
      chatHistory[data.from].push({ from: data.from, message: data.message, timestamp: data.timestamp });
      if (currentChat === data.from) renderChat(currentChat);
    }
  };

  socket.onclose = () => {
    document.getElementById('status').textContent = 'Disconnected';
  };
}

function openChat(user) {
  currentChat = user;
  if (!chatHistory[user]) chatHistory[user] = [];
  renderChat(user);
}

function send() {
  const msgInput = document.getElementById('msg');
  const msg = msgInput.value.trim();
  if (!msg || !currentChat) return;
  socket.send(JSON.stringify({ type: 'message', to: currentChat, message: msg }));
  if (!chatHistory[currentChat]) chatHistory[currentChat] = [];
  chatHistory[currentChat].push({ from: username, message: msg, timestamp: new Date().toLocaleTimeString() });
  renderChat(currentChat);
  msgInput.value = '';
}

function renderChat(user) {
  const chat = document.getElementById('chat');
  chat.innerHTML = '';
  chatHistory[user].forEach(msg => {
    const div = document.createElement('div');
    div.className = 'message ' + (msg.from === username ? 'right' : 'left');
    div.innerHTML = msg.message + `<span class="timestamp"> [${msg.timestamp}]</span>`;
    chat.appendChild(div);
  });
  chat.scrollTop = chat.scrollHeight;
}

window.addEventListener('load', () => connectWS());
</script>
</body>
</html>
